<!DOCTYPE html>
<html class="light" lang="ko">
<head>
  <%- include('../partials/head') %>
  <title>마이페이지 | Campus flea Market</title>
</head>
<body class="bg-main font-display">
  <div class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden">
    <div class="layout-container flex h-full grow flex-col">
      <%- include('../partials/header') %>
      
      <!-- 메인 콘텐츠 -->
      <main class="px-4 py-10 md:px-10 lg:px-20 xl:px-40 flex flex-1 justify-center">
        <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
          <!-- 프로필 섹션 -->
          <div class="profile-card">
            <div class="profile-content">
              <div class="profile-info">
                <label for="profile-image-upload" style="cursor: pointer; position: relative; display: inline-block;">
                  <div class="profile-avatar" style='background-image: url("<%= typeof user !== 'undefined' && user.profile_img ? user.profile_img : 'https://i.pravatar.cc/150?img=1' %>");'></div>
                  <div style="position: absolute; bottom: 0; right: 0; background-color: rgba(0, 0, 0, 0.6); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; pointer-events: none;">
                    <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle;">camera_alt</span>
                  </div>
                </label>
                <input type="file" id="profile-image-upload" name="profile_img" accept="image/*" style="display: none;" />
                <!-- 프로필 정보 -->
                <div class="profile-details">
                  <p class="profile-name"><%= typeof user !== 'undefined' && user.nickname ? user.nickname : '사용자' %></p>
                  <p class="profile-email"><%= typeof user !== 'undefined' && user.email ? user.email : 'email@example.com' %></p>
                  <% if (typeof user !== 'undefined' && user.campus) { %>
                  <p class="profile-campus"><%= user.campus %></p>
                  <% } %>
                </div>
              </div>
              <!-- 프로필 수정 버튼 -->
              <button type="button" id="open-edit-modal" class="profile-edit-button">
                <span class="truncate">프로필 수정</span>
              </button>
            </div>
          </div>
          
          <!-- 탭 및 상품 목록 -->
          <div class="tab-menu">
            <!-- 탭 메뉴 -->
            <div class="tab-list">
              <div class="tab-nav">
                <a class="tab-item <%= tab === 'sales' ? 'tab-item-active' : '' %>" href="/user/profile?tab=sales">
                  <p class="tab-text">판매 내역</p>
                </a>
                <a class="tab-item <%= tab === 'wishlist' ? 'tab-item-active' : '' %>" href="/user/profile?tab=wishlist">
                  <p class="tab-text">찜한 목록</p>
                </a>
              </div>
            </div>
            <!-- 상품 그리드 -->
            <div class="user-product-grid">
              <% if (typeof products !== 'undefined' && products.length > 0) { %>
                <% products.forEach(product => { %>
                <a href="/product/<%= product.id %>" class="user-product-card">
                  <div class="user-product-image" style='background-image: url("<%= product.thumbnail || product.main_image || '/uploads/default.jpg' %>");'></div>
                  <div class="user-product-info">
                    <p class="user-product-title"><%= product.title %></p>
                    <p class="user-product-price">₩<%= product.price.toLocaleString() %></p>
                    <p class="user-product-status <%= product.status === 'FOR_SALE' ? 'user-product-status-active' : 'user-product-status-inactive' %>"><%= product.status === 'FOR_SALE' ? '판매중' : product.status === 'RESERVED' ? '예약중' : '판매완료' %></p>
                  </div>
                </a>
                <% }); %>
              <% } else { %>
                <div class="empty-state">
                  <p class="empty-state-text">등록된 상품이 없습니다.</p>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </main>
      <%- include('../partials/footer') %>
    </div>
  </div>
  
  <%- include('../partials/profile-edit-modal') %> <!--모달은 반드시 body 바로 아래에 위치해야함!-->
  <script src="/js/common.js"></script>
  <script src="/js/auth.js"></script>
  
  <script>
    var hasError = <%- typeof error !== 'undefined' && error ? 'true' : 'false' %>;
  </script>
  
  <!-- 모달 + 비번 검증 -->
  <script>
    (function() {
      // 모달 관련 요소 선택
      const modal = document.getElementById('edit-profile-modal'); // 모달 컨테이너
      const openBtn = document.getElementById('open-edit-modal'); // 모달 열기 버튼
      const closeBtn = document.getElementById('close-edit-modal'); // X 버튼
      const cancelBtn = document.getElementById('cancel-edit-modal'); // 취소 버튼
      const overlay = document.querySelector('.profile-edit-modal-overlay'); // 배경 오버레이
      const passwordInput = document.getElementById('password-input'); // 비밀번호 입력 필드
      const passwordConfirmInput = document.getElementById('password-confirm-input'); // 비밀번호 확인 필드
      const form = document.getElementById('edit-profile-form'); // 폼 요소
      
      // 모달 열기 함수
      function openModal() {
        if (modal) {
          // display: none → display: flex로 변경하여 모달 표시
          modal.style.display = 'flex';
          // 배경 페이지 스크롤 방지 (모달이 열려있을 때 배경이 스크롤되지 않도록)
          document.body.style.overflow = 'hidden';
        }
      }
      
      // 모달 열기 버튼 클릭 이벤트
      if (openBtn) {
        openBtn.addEventListener('click', function(e) {
          e.preventDefault(); // 버튼의 기본 동작 방지
          openModal(); // 모달 열기 함수 호출
        });
      }
      
      // 에러 메시지가 있으면 자동으로 모달 열기
      // EJS에서 전달된 error 변수를 JavaScript 변수로 변환하여 사용
      if (hasError) {
        openModal();
      }
      
      // 모달 닫기
      function closeModal() {
        if (modal) {
          // display: flex → display: none으로 변경하여 모달 숨김
          modal.style.display = 'none';
          // 배경 페이지 스크롤 복원
          document.body.style.overflow = '';
        }
      }
      
      // X 버튼 클릭 시 모달 닫기
      if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
      }
      
      // 취소 버튼 클릭 시 모달 닫기
      if (cancelBtn) {
        cancelBtn.addEventListener('click', closeModal);
      }
      
      // ESC 키 누를 때 모달 닫기
      document.addEventListener('keydown', function(e) {
        // ESC 키이고 모달이 열려있으면 닫기
        if (e.key === 'Escape' && modal && modal.style.display === 'flex') {
          closeModal();
        }
      });
      
      // 폼 제출 시 비밀번호 확인 검증
      if (form) {
        form.addEventListener('submit', function(e) {
          const password = passwordInput.value;
          const passwordConfirm = passwordConfirmInput.value;
          
          // 비밀번호를 입력했는데 확인이 비어있으면
          if (password && !passwordConfirm) {
            e.preventDefault(); // 폼 제출 방지
            alert('비밀번호 확인을 입력해주세요.');
            passwordConfirmInput.focus(); // 확인 필드로 포커스 이동
            return false;
          }
          
          // 비밀번호와 확인이 다르면
          if (password && passwordConfirm && password !== passwordConfirm) {
            e.preventDefault();
            alert('비밀번호가 일치하지 않습니다.');
            passwordConfirmInput.focus();
            return false;
          }
          
          // 비밀번호 길이 검증 (최소 6자)
          if (password && password.length < 6) {
            e.preventDefault();
            alert('비밀번호는 최소 6자 이상이어야 합니다.');
            passwordInput.focus();
            return false;
          }
        });
      }
    })();
  </script>

  <!-- 프로필 이미지 업로드 스크립트 -->
  <script>
    (function() {
      const profileImageUpload = document.getElementById('profile-image-upload');
      const profileAvatar = document.getElementById('profile-avatar');
      
      if (profileImageUpload) {
        profileImageUpload.addEventListener('change', function(event) {
          const file = event.target.files[0];
          
          if (!file) return;
          
          // 이미지 파일인지 확인
          if (!file.type.startsWith('image/')) {
            alert('이미지 파일만 업로드할 수 있습니다.');
            event.target.value = '';
            return;
          }
          
          // 파일 크기 확인 (5MB 제한)
          if (file.size > 5 * 1024 * 1024) {
            alert('파일 크기는 5MB 이하여야 합니다.');
            event.target.value = '';
            return;
          }
          
          // 미리보기 표시
          const reader = new FileReader();
          reader.onload = function(e) {
            if (profileAvatar) {
              profileAvatar.style.backgroundImage = `url(${e.target.result})`;
            }
          };
          reader.readAsDataURL(file);
          
          // FormData 생성
          const formData = new FormData();
          formData.append('profile_img', file);
          
          // AJAX로 업로드
          fetch('/user/profile-image', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // 성공 시 페이지 새로고침하여 서버에서 업데이트된 이미지 표시
              window.location.reload();
            } else {
              alert(data.message || '프로필 이미지 업로드에 실패했습니다.');
              // 실패 시 원래 이미지로 복원
              if (profileAvatar) {
                profileAvatar.style.backgroundImage = 'url("<%= typeof user !== 'undefined' && user.profile_img ? user.profile_img : 'https://i.pravatar.cc/150?img=1' %>")';
              }
            }
          })
          .catch(error => {
            console.error('프로필 이미지 업로드 오류:', error);
            alert('프로필 이미지 업로드 중 오류가 발생했습니다.');
            // 오류 시 원래 이미지로 복원
            if (profileAvatar) {
              profileAvatar.style.backgroundImage = 'url("<%= typeof user !== 'undefined' && user.profile_img ? user.profile_img : 'https://i.pravatar.cc/150?img=1' %>")';
            }
          });
        });
      }
    })();
  </script>
</body>
</html>

