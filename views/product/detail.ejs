  <!DOCTYPE html>
  <html class="light" lang="ko">
  <head>
    <%- include('../partials/head') %>
    <title><%= typeof product !== 'undefined' ? product.title : '상품 상세' %> | Campus flea Market</title>
  </head>
  <body class="font-display bg-main text-main">
    <div class="relative flex min-h-screen w-full flex-col group/design-root overflow-x-hidden">
      <div class="layout-container flex h-full grow flex-col">
        <%- include('../partials/header') %>
        
        <!-- 메인 콘텐츠 -->
        <main>
          <div class="product-detail-container">
            <!-- 브레드크럼 -->
            <div class="breadcrumb">
              <a class="breadcrumb-link" href="/">Home</a>
              <span class="breadcrumb-separator">/</span>
              <a class="breadcrumb-link" href="/product/list"><%= typeof product !== 'undefined' ? product.category : 'Electronics' %></a>
              <span class="breadcrumb-separator">/</span>
              <span class="breadcrumb-current"><%= typeof product !== 'undefined' ? product.title : '상품' %></span>
            </div>
            
            <div class="product-detail-grid">
              <!-- 왼쪽: 상품 이미지 갤러리 -->
              <div class="image-gallery">
                <div class="main-image-wrapper">
                  <!-- 대표 이미지 -->
                  <img 
                    alt="<%= typeof product !== 'undefined' ? product.title : '상품 이미지' %>" 
                    class="main-image" 
                    src="<%= product.images && product.images[0] ? product.images[0].image_path : '/uploads/default.jpg' %>"
                  />
                  <!-- 이미지 인디케이터 -->
                  <div class="image-indicators">
                    <% if (typeof product !== 'undefined' && product.images && product.images.length > 0) { %>
                      <% product.images.forEach((img, index) => { %>
                      <div class="image-indicator <%= index === 0 ? 'image-indicator-active' : '' %>"></div>
                      <% }); %>
                    <% } else { %>
                      <div class="image-indicator image-indicator-active"></div>
                    <% } %>
                  </div>
                </div>
              </div>
              
              <!-- 오른쪽: 상품 정보 -->
              <div class="flex flex-col gap-6">
                <!-- 판매자 프로필 -->
                <div class="seller-profile">
                  <div class="seller-info">
                    <!-- 판매자 프로필 이미지 -->
                    <div class="seller-avatar" style='background-image: url("<%= typeof seller !== 'undefined' && seller && seller.profile_img ? seller.profile_img : '/uploads/default.jpg' %>");'></div>
                    <!-- 판매자 정보 -->
                    <div style="flex: 1;">
                      <p class="seller-name"><%= typeof seller !== 'undefined' && seller ? seller.nickname : '판매자' %></p>
                      <p class="seller-verified">University Student</p>
                    </div>
                    <!-- 게시물 삭제 버튼 (판매자만 표시) -->
                    <% if (typeof user !== 'undefined' && user && typeof product !== 'undefined' && product.seller_id === user.id) { %>
                    <button 
                      class="product-delete-btn" 
                      onclick="deleteProduct(<%= product.id %>)"
                      style="background-color: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-weight: 500; transition: background-color 0.2s;"
                      onmouseover="this.style.backgroundColor='#dc2626'"
                      onmouseout="this.style.backgroundColor='#ef4444'"
                    >
                      게시물 삭제
                    </button>
                    <% } %>
                  </div>
                  <!-- 수정 버튼 (판매자만 표시) -->
                  <% if (typeof user !== 'undefined' && user && typeof product !== 'undefined' && product.seller_id === user.id) { %>
                  <div class="action-buttons">
                    <a href="/product/<%= product.id %>/edit" class="action-btn action-btn-edit">수정</a>
                  </div>
                  <% } %>
                </div>
                
                <!-- 상품 상태 선택 (판매자만) -->
                <% if (user && product && product.seller_id === user.id) { %>
                <div class="status-selector">
                  <form action="/product/<%= product.id %>/status" method="POST" class="status-form">

                    <label class="status-radio-label">
                      <input 
                        class="sr-only" 
                        name="product-status" 
                        type="radio" 
                        value="FOR_SALE" 
                        <%= product.status === 'FOR_SALE' ? 'checked' : '' %> 
                      />
                      <span class="truncate">판매중</span>
                    </label>

                    <label class="status-radio-label">
                      <input 
                        class="sr-only" 
                        name="product-status" 
                        type="radio" 
                        value="RESERVED" 
                        <%= product.status === 'RESERVED' ? 'checked' : '' %> 
                      />
                      <span class="truncate">예약중</span>
                    </label>

                    <label class="status-radio-label">
                      <input 
                        class="sr-only" 
                        name="product-status" 
                        type="radio" 
                        value="SOLD" 
                        <%= product.status === 'SOLD' ? 'checked' : '' %> 
                      />
                      <span class="truncate">판매완료</span>
                    </label>

                  </form>
                </div>
                <% } %>
                
                <!-- 상품명 및 가격 -->
                <div class="product-info-section">
                  <div>
                    <!-- 상품명 -->
                    <h1 class="product-name"><%= typeof product !== 'undefined' ? product.title : '상품명' %></h1>
                    <!-- 카테고리 및 등록 시간 -->
                    <p class="product-meta-info"><%= typeof product !== 'undefined' ? product.category : '카테고리' %> · <%= typeof product !== 'undefined' && product.created_at ? product.created_at : '방금 전' %></p>
                  </div>
                  <div class="flex items-center gap-4">
                    <!-- 가격 -->
                    <p class="product-price-large">₩<%= typeof product !== 'undefined' ? product.price.toLocaleString() : '0' %></p>
                    <!-- 찜하기 버튼 및 개수 (로그인한 사용자만 표시) -->
                    <% if (user && product.seller_id !== user.id) { %>
                      <div class="flex items-center gap-2">
                        <button class="like-button" data-like-product="<%= product.id %>" type="button">
                          <span class="material-symbols-outlined">favorite_border</span>
                        </button>
                         
                      </div>
                    <% } %>
                    <!-- 로그인하지 않은 사용자는 찜 개수만 표시 -->
                    <div class="flex items-center gap-1 text-sub">
                      <span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">favorite</span>
                      <span class="like-count"><%= typeof product !== 'undefined' && product.like_count ? product.like_count : 0 %></span>
                    </div>
                  </div>
                </div>
                
                <!-- 상품 설명 -->
                <div class="product-description">
                  <p class="product-description-text">
                    <%= typeof product !== 'undefined' && product.description ? product.description.replace(/\n/g, '<br/>') : '상품 설명이 없습니다.' %>
                  </p>
                </div>
              </div>
            </div>
            
            <!-- 댓글 섹션 -->
            <div class="comments-section">
              <div class="comments-header">
                <h2 class="comments-title">댓글</h2>
                <span class="comments-count"><%= typeof comments !== 'undefined' && comments ? comments.length : 0 %>개</span>
              </div>
              
              <!-- 댓글 작성 폼 -->
              <% if (typeof user !== 'undefined' && user) { %>
              <div class="comment-form-wrapper">
                <form class="comment-form" action="/product/<%= typeof product !== 'undefined' ? product.id : '' %>/comment" method="POST">
                  <div class="comment-form-content">
                    <div class="comment-user-avatar" style='background-image: url("<%= user.profile_img || '/uploads/default.jpg' %>");'></div>
                    <div class="comment-input-wrapper">
                      <textarea 
                        class="comment-input" 
                        name="content" 
                        placeholder="댓글을 입력하세요..." 
                        rows="3" 
                        autocomplete="off"
                        required
                      ></textarea>
                      <div class="comment-form-actions">
                        <button type="submit" class="comment-submit-btn">등록</button>
                      </div>
                    </div>
                  </div>
                </form>
              </div>
              <% } else { %>
              <div class="comment-login-prompt">
                <p>댓글을 작성하려면 <a href="/auth/login" class="comment-login-link">로그인</a>이 필요합니다.</p>
              </div>
              <% } %>
              
              <!-- 댓글 목록 -->
              <div class="comments-list">
                <% if (typeof comments !== 'undefined' && comments && comments.length > 0) { %>
                  <% comments.forEach(comment => { %>
                    <%- include('../partials/comment-item', { commentItem: comment, product: product, user: user }) %>
                  <% }); %>
                <% } else { %>
                <div class="comments-empty">
                  <p class="comments-empty-text">아직 댓글이 없습니다. 첫 댓글을 작성해보세요!</p>
                </div>
                <% } %>
              </div>
            </div>
          </div>
        </main>
        
        <%- include('../partials/footer') %>
      </div>
    </div>
    
    <!-- 상품 관련 JavaScript -->
    <script src="/js/product.js"></script>
  </body>
  </html>
